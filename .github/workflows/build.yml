name: Build

on:
  push:
    branches: [ main ]

jobs:
  # ─── Desktop builds (Linux · macOS · Windows) ───────────────────────────────
  build-desktop:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # OpenGL dev headers are not installed by default on Ubuntu runners
      - name: Install OpenGL dev headers (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libgl-dev

      - name: Configure
        run: cmake --preset release

      - name: Build
        run: cmake --build --preset release --parallel

  # ─── Web / Emscripten build (Linux runner) ───────────────────────────────────
  build-web:
    name: Build (Web)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14

      # Override the preset's toolchainFile with the one installed by setup-emsdk
      # so CI doesn't depend on the bundled emsdk submodule having the toolchain
      # pre-installed (the submodule contains only the emsdk scripts, not the
      # full toolchain — those are downloaded by setup-emsdk with caching).
      - name: Configure (Web)
        run: cmake --preset web -DCMAKE_TOOLCHAIN_FILE="$EMSDK/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake"

      - name: Build (Web)
        run: cmake --build --preset web --parallel
